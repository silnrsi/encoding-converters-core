# Master Makefile for the encConverters package
# Makefile.in created January 20, 2012 by Stephen McConnel

@SET_MAKE@
# the next line requires GNU make ...
MAKEFLAGS=#--no-print-directory
srcdir = @srcdir@
VPATH  = @srcdir@
INSTALL     = @INSTALL@
prefix      = @prefix@
exec_prefix = @exec_prefix@
ROOTDIR     = @abs_top_srcdir@
OUTDIR      = $(ROOTDIR)/output/Debug

SRCDIRS = src/IcuEC src/PyScriptEC src/ECDriver/linux
DLLS    = ECInterfaces.dll SilEncConverters40.dll CodePageEC.dll CcEC.dll \
  IcuEC.dll PyScriptEC.dll PerlExpressionEC.dll AIGuesserEC.dll
LIBDIR  = $(exec_prefix)/lib/encConverters
PLUGINS = "AI 4.0.0.0 Plugin Details.xml" "CC 4.0.0.0 Plugin Details.xml" \
    "CP 4.0.0.0 Plugin Details.xml" "EC 4.0.0.0 Plugin Details.xml" \
    "IcuEC 4.0.0.0 Plugin Details.xml" "PerlEC 4.0.0.0 Plugin Details.xml" \
    "PythonEC 4.0.0.0 Plugin Details.xml"

all:
	@(cd build && nant) || true
	@for subdir in $(SRCDIRS); do \
	  echo making in $$subdir; \
	  (cd $$subdir && $(MAKE) all) || true; \
	done
	@mkdir -p $(OUTDIR)/EC/Plugins
	@for file in $(PLUGINS); do \
	  cp src/Plugins/"$$file" $(OUTDIR)/EC/Plugins; \
	done
	@cp src/TestEncCnvtrs/TestEncCnvtrs.dll.config $(OUTDIR)

clean:
	@(cd build && nant clean) || true
	@for subdir in $(SRCDIRS); do \
	  echo making in $$subdir; \
	  (cd $$subdir && $(MAKE) clean) || true; \
	done
	@(cd $(OUTDIR) && rm -f *.xml) || true
	@(cd $(OUTDIR) && rm -rf EC) || true
	@rm -f *~

distclean: clean
	@for subdir in $(SRCDIRS); do \
	  echo making in $$subdir; \
	  (cd $$subdir && $(MAKE) distclean) || true; \
	done
	@rm -f Makefile config.cache src/config.h config.log config.status src/stamp-h1 autogen.err
	@rm -rf autom4te.cache output build/Obj

install:
	@for subdir in $(SRCDIRS); do \
	  echo installing in $$subdir; \
	  (cd $$subdir && $(MAKE) install) || true; \
	done
	@mkdir -p $(DESTDIR)$(LIBDIR)
	@for file in $(DLLS); do \
	  $(INSTALL) $(OUTDIR)/$$file $(DESTDIR)$(LIBDIR); \
	done

NUNITROOT=`which nunit-console | sed s=/bin/nunit-console==`
check: all
	@if [ ! -f $(OUTDIR)/nunit.framework.dll ]; then \
	  echo '#' even with nunit in the GAC, we seem to need need this copying...; \
	  find $(NUNITROOT) -name nunit.framework.dll -exec cp -p '{}' $(OUTDIR) ';' -print ; \
	  find $(NUNITROOT) -name nunit.core.dll -exec cp -p '{}' $(OUTDIR) ';' -print ; \
	  find $(NUNITROOT) -name nunit.core.interfaces.dll -exec cp -p '{}' $(OUTDIR) ';' -print ; \
	fi
	@(cd build && LD_LIBRARY_PATH="$(OUTDIR)" nant test) || true
	@for subdir in $(SRCDIRS); do \
	  echo checking in $$subdir; \
	  (cd $$subdir && $(MAKE) check) || true; \
	done
